---
// Responsive article ad component
// - Scans `src/assets/images/article-ad` for files named `name.desktop.*` and `name.mobile.*`
// - Randomly selects one `name` group on render and outputs a <picture> with desktop/mobile sources
// Naming convention example: `banner1.desktop.svg`, `banner1.mobile.svg`
const modules = Object.entries(
  import.meta.glob(
    "/src/assets/images/article-ad/*.{png,jpg,jpeg,webp,avif,svg}",
    { eager: true },
  ),
);

function buildGroups(entries) {
  const groups = {};
  for (const [p, mod] of entries) {
    const parts = p.split("/").pop();
    const m = parts.match(/^(.*)\.(desktop|mobile)\.[^.]+$/);
    if (!m) continue;
    const key = m[1];
    const kind = m[2];
    const url = mod && mod.default ? mod.default : p;
    groups[key] = groups[key] || {};
    groups[key][kind] = url;
  }
  return groups;
}

const groups = buildGroups(modules);
const keys = Object.keys(groups);

let chosen = null;
if (keys.length > 0) {
  const k = keys[Math.floor(Math.random() * keys.length)];
  chosen = groups[k];
}
---

<div class="container max-w-5xl my-4 flex justify-center">
  <div
    id="article-ad"
    class="w-full lg:w-3/4 h-20 sm:h-24 lg:h-28 bg-base-200 dark:bg-base-300 flex items-center justify-center rounded-md overflow-hidden"
    role="region"
    aria-label="Advertisement"
  >
    {
      chosen ? (
        <picture>
          {chosen.desktop ? (
            <source srcset={chosen.desktop} media="(min-width: 1024px)" />
          ) : null}
          <img
            src={chosen.mobile ?? chosen.desktop}
            alt="Article ad"
            class="w-full h-full object-cover"
          />
        </picture>
      ) : (
        <span class="text-sm text-base-content/70">
          Ad placeholder â€” replace with ad code
        </span>
      )
    }
  </div>
</div>
